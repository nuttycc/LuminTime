# LuminTime

Privacy-first browser extension that tracks online activity locally. Built with WXT + Vue 3 + Dexie.js.

## Commands

```bash
bun install           # Install deps (runs wxt prepare postinstall)
bun run dev           # Dev server with HMR → load .output/chrome-mv3/ in chrome://extensions/
bun run build         # Production build
bun run zip           # Chrome extension ZIP
bun run zip:firefox   # Firefox extension ZIP
bun run compile       # Type check (vue-tsc --noEmit)
bun run lint          # Oxlint static analysis
bun run format        # Code formatting (oxfmt)
bun run test          # Vitest unit tests
```

## Architecture

```
background.ts (service worker)
  └─ SessionManager ─── tracks active tab via browser events
        └─ writes to ──→ Dexie IndexedDB

popup/ (Vue 3 SPA)
  └─ pages/ ─── read from ──→ Dexie IndexedDB (live queries)
  └─ composables/ ─── useDexieLiveQuery, useDateRange
```

**Data model (3-layer hierarchy):**

- `HistoryLog` — raw session events, indexed by `[date+hostname]`
- `SiteStat` — daily aggregates per hostname, indexed by duration for rankings
- `PageStat` — daily aggregates per path
- `HourlyStat` — generated by retention job from old HistoryLog records

## Key Files

| File                              | Purpose                                                     |
| --------------------------------- | ----------------------------------------------------------- |
| `src/entrypoints/background.ts`   | Service worker entry; wires browser events → SessionManager |
| `src/utils/SessionManager.ts`     | Core tracking logic with DI, debounce, async queue          |
| `src/db/index.ts`                 | Dexie database instance & schema                            |
| `src/db/types.ts`                 | Arktype schemas for all tables                              |
| `src/db/service.ts`               | Query & aggregation functions                               |
| `src/entrypoints/popup/router.ts` | Vue Router with 5 routes                                    |
| `wxt.config.ts`                   | Extension manifest, permissions, Tailwind plugin            |

## Code Style

- `<script setup lang="ts">` for all Vue components
- Path alias `@/` for src imports
- Arktype for runtime type validation: `type IFoo = typeof FooSchema.infer`
- Oxlint for linting (not ESLint); oxfmt for formatting
- camelCase for functions/variables, PascalCase for classes/types/components

## Gotchas

- **Midnight splitting:** Sessions crossing midnight are split into separate HistoryLog records via `splitByMidnight()` — daily aggregations depend on this
- **URL normalization:** `www.` stripped, tracking params (utm\_\*, fbclid, gclid) removed; handles file://, chrome-extension://, about:// protocols
- **Blocklist cache:** Background script keeps in-memory cache; popup sends `"blocklist-updated"` message to refresh it after changes
- **SessionManager debounce:** 500ms debounce on tab switches prevents recording rapid switches as separate sessions
- **Dexie compound keys:** Tables use `[date+hostname]` as primary key; upsert pattern = fetch → update or insert, all within single transaction
- **Retention job:** Runs via alarm, converts old raw history → HourlyStat, then deletes raw records to bound storage

## Testing

- Vitest with node environment, globals auto-imported
- Tests in `tests/` mirror src structure
- SessionManager tests use `vi.useFakeTimers()` + `vi.advanceTimersByTimeAsync()`
- DB tests mock Dexie; no browser environment needed
- Run single test: `bun run test -- tests/db/service.test.ts`
