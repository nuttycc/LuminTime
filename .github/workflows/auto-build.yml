name: Nightly Build and Release

on:
  workflow_dispatch:
  schedule:
    - cron: "0 0 * * *"

concurrency:
  group: nightly-build-release-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: write

jobs:
  nightly-build-and-release:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Setup Bun runtime
        uses: oven-sh/setup-bun@v2

      - name: Restore Bun dependency cache
        uses: actions/cache@v5
        with:
          path: ~/.bun/install/cache
          key: ${{ runner.os }}-bun-${{ hashFiles('bun.lock') }}
          restore-keys: ${{ runner.os }}-bun-

      - name: Install dependencies
        run: bun install

      - name: Run type check and lint
        run: bun run compile && bun run lint

      - name: Read version from package.json
        id: pkg
        run: echo "version=$(jq -r .version package.json)" >> $GITHUB_OUTPUT

      - name: Build Chrome extension ZIP
        run: bun run zip

      - name: Build Firefox extension ZIP
        run: bun run zip:firefox

      - name: Set nightly release metadata
        id: release
        run: |
          BUILD_TIME_UTC="$(date -u +'%Y-%m-%d %H:%M:%S UTC')"
          echo "build_time_utc=$BUILD_TIME_UTC" >> $GITHUB_OUTPUT
          echo "tag=nightly" >> $GITHUB_OUTPUT
          echo "name=Nightly Build ($BUILD_TIME_UTC)" >> $GITHUB_OUTPUT
          echo "prerelease=true" >> $GITHUB_OUTPUT

      - name: Delete existing nightly release and tag
        if: steps.release.outputs.prerelease == 'true'
        run: |
          gh release delete ${{ steps.release.outputs.tag }} --yes || true
          git push origin :refs/tags/${{ steps.release.outputs.tag }} || true
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Publish nightly release
        run: |
          gh release create ${{ steps.release.outputs.tag }} \
            --prerelease \
            --title "${{ steps.release.outputs.name }}" \
            --notes "Auto-generated nightly build from main branch.

          **Build Time (UTC):** ${{ steps.release.outputs.build_time_utc }}
          **Commit:** ${{ github.sha }}" \
            .output/*.zip
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Write workflow summary
        run: |
          echo "## ðŸš€ Build Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Item | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Version | \`${{ steps.pkg.outputs.version }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Tag | \`${{ steps.release.outputs.tag }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Type | ðŸ§ª Nightly prerelease |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“¦ Artifacts" >> $GITHUB_STEP_SUMMARY
          ls -lh .output/*.zip | awk '{print "- `" $NF "` (" $5 ")"}' >> $GITHUB_STEP_SUMMARY
